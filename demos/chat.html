<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="keywords" content="JavaScript, ES6, functional, simpatico, minimalist, web verite">
  <meta name="author" content="javajosh">
  <link id="favicon" rel="icon" type="image/png" href="../img/wizard-192x192.png"/>

  <title>websockets</title>
  <link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>
<h1>Simpatico</h1>
<p>javajosh <i>2023</i></p>

<p>
  This is a very tiny chat system that demonstrates raw websockets in the browser.
</p>

<h3>Messages</h3>
<ol id="display-chat">
  <li><label>Say something:<input type="text"></label></li>
</ol>

<script type="module">
  console.log("Simpatico chat boot", "UTC", new Date().toUTCString(), "ms since epoch", Date.now(), window.location);
  const elt = document.getElementById.bind(document);
  const displayChat = elt("display-chat");

  // Display a string as a new list element
  const displayHtmlString = (msg, parent = displayChat) => {
    // Compare with string manipulation version of this
    const li = document.createElement("li");
    li.innerHTML = msg;
    parent.appendChild(li);
    console.debug(`msg received and appended as li [${msg}]`);
  }

  // Read: Open the socket and route inbound messages to the DOM
  const connect = (url, greeting = '<b>hey</b>') => {
    const conn = new WebSocket(url);
    conn.onopen = () => conn.send(greeting);
    conn.onmessage = e => displayHtmlString(e.data);
    return conn;
  }
  const websocketURL = window.location.toString().replace(/^http/, 'ws');
  let connection = connect(websocketURL);
  const isConnReady = (conn = connection) => conn !== undefined && conn.readyState === conn.OPEN;

  // Write: User input is received. Route outbound messages from the DOM to the connection.
  // if the connection is down, try to reestablish.
  // if the connection is up, send the target.value as a string.
  document.body.onchange = e => {
    try {
      if (!isConnReady()){
        console.log('connection down attempting reconnect', url);
        connection = connect(url);
      }
      if (isConnReady()) {
        const msg = e.target.value;
        connection.send(msg);
        console.debug(`msg received ${msg}`);
      }
    } catch (e) {
      console.error('problem processing change input');
      throw e;
    }
    return false;
  }
</script>
</body>
</html>
