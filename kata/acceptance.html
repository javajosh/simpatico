<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="keywords" content="JavaScript, ES6, functional, simpatico, minimalist, web verite">
  <meta name="author" content="javajosh">

  <!-- Begin testable.js html boilerplate; testable.js is in the same directory -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'>
      <rect width='1' height='1' fill='white' />
  </svg>"/>
  <script src="testable.js" type="module"></script>
  <!-- End testable.js boilerplate  -->


  <title>testing</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
<h1>testing</h1>
<p>javajosh <i>2023</i></p>

<iframe id="homepage-frame"
        title="homepage"
        width="300"
        height="200"
        src="/index.html">
</iframe>
<iframe id="core-frame"
        title="core"
        width="300"
        height="200"
        src="/core">
</iframe>
<iframe id="combine-frame"
        title="combine"
        width="300"
        height="200"
        src="/combine">
</iframe>
<iframe id="combine2-frame"
        title="combine"
        width="300"
        height="200"
        src="/combine2.md">
</iframe>
<iframe id="stree-frame"
        title="stree"
        width="300"
        height="200"
        src="/stree">
</iframe>
<iframe id="stree2-frame"
        title="stree"
        width="300"
        height="200"
        src="/stree2.md">
</iframe>
<iframe id="crypto-frame"
        title="crypto"
        width="300"
        height="200"
        src="/crypto">
</iframe>
<iframe id="friendly-frame"
        title="friendly"
        width="300"
        height="200"
        src="/friendly">
</iframe>
<iframe id="svg-frame"
        title="svg"
        width="300"
        height="200"
        src="/svg">
</iframe>
<iframe id="chat-frame"
        title="chat"
        width="300"
        height="200"
        src="/chat">
</iframe>

<h2>iframe</h2>
<p>
  If your test suite is self-executing html pages, then just including them as an
  <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe">iframe</a> and checking their color is enough.
  This technique is mapping over html resources with a "fresh" browser to produce a tab state.
</p>
<p>
  Possibly interesting: <a href="https://www.benmarshall.me/responsive-iframes/">iframes in responsive layouts</a>.
</p>

<h2>Curl</h2>
<p>
  Curl is very straightforward on mac and linux.
  Curl in windows can run in wsl, but it can be difficult to hit a windows node process.
  Curl native to windows must be <a href="https://curl.se/windows/">installed manually</a>.
  Native win10 curl takes the url first and won't accept quotes.
  (Although win10/chrome has some interesting options for "copy value as" like powershell, cmd or bash).
</p>

<p>Here is what you get if you "copy as curl" on Linux/Firefox</p>
<code><pre>
  curl 'https://simpatico.io/' \
  -H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0' \
  -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8'\
  -H 'Accept-Language: en-US,en;q=0.5' \
  -H 'Accept-Encoding: gzip, deflate, br' \
  -H 'DNT: 1' \
  -H 'Connection: keep-alive' \
  -H 'Upgrade-Insecure-Requests: 1' \
  -H 'Sec-Fetch-Dest: document' \
  -H 'Sec-Fetch-Mode: navigate' \
  -H 'Sec-Fetch-Site: none' \
  -H 'Sec-Fetch-User: ?1' \
  -H 'Pragma: no-cache' \
  -H 'Cache-Control: no-cache'
</pre></code>

<p>
  Manipulation of the request at this level is useful for testing code that rejects invalid requests.
  For example, missing User-Agent headers.
  Note that the <code>reflector</code> is insensitive to almost all of these headers.
  (However, <code>node:http</code> <i>may</i> be sensitive to them.)
</p>

<code><pre>
  curl 'https://simpatico.io/' \
  -H 'User-Agent: Can be anything but blank' \
  -H 'Accept-Encoding: gzip, deflate, br' \
  -H 'X-The-Rest: are ignored
</pre></code>

<code><pre>
  curl 'https://simpatico.local:8443/' -H 'User-Agent: '
</pre></code>

<h2>Fetch</h2>
<p>
  Browser dev tools network pane copy value as fetch.
  This can be used in browser javascript, or in node javascript.
  See html source:
</p>
<script type="module">
  // This "fetch()" is equivalent to the curl above
  if (!window.location) await fetch("https://simpatico.io/", {
    "credentials": "omit",
    "headers": {
      "User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0",
      "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
      "Accept-Language": "en-US,en;q=0.5",
      "Upgrade-Insecure-Requests": "1",
      "Sec-Fetch-Dest": "document",
      "Sec-Fetch-Mode": "navigate",
      "Sec-Fetch-Site": "none",
      "Sec-Fetch-User": "?1",
      "Pragma": "no-cache",
      "Cache-Control": "no-cache"
    },
    "method": "GET",
    "mode": "cors"
  });
</script>

<script type="module">

  const svgIcon = fill => `data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'>
        <rect width='1' height='1' fill='${fill}' />
    </svg>`;

  // Here we interact with the iframes indirectly, by listening for events the iframes may emit.
  window.addEventListener('test-failure', () => {
    favicon.href = svgIcon('red');
    document.body.style.backgroundColor = 'red';
  })
  window.addEventListener('test-success', () => {
    favicon.href = svgIcon('green');
  })
</script>
