<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Green Square</title>
</head>

<body>
  <h2>Things you can do:</h2>
  <ol>
    <li>Watch the pretty animation.</li>
    <li>Start and stop the animation with the space bar.</li>
    <li>Interact with the dev console.</li>
  </ol>

  <svg width="500" height="500">
    <rect id="1" x="50" y="50" width="100" height="100" fill="green" />
  </svg>

  <script>
  'use strict';

	if (navigator.userAgent.indexOf("MSIE") > -1) window.alert('IE not supported. Use Firefox, Chrome, Opera, Safari or Edge');

  const number = val => {
  	if (typeof val !== 'number') throw new Error(`${val} is not a number`);
  };
  const string = val => {
  	if (typeof val !== 'string') throw new Error(`${val} is not a string`);
  };

  // Define the basic degrees of freedom in the DOM.
  const SQUARE = document.getElementById('1');

  // Now lets output circular motion. 
  function* circlePath(stepsPerRotation = 60, theta = 0){
  	while (true) {
  		theta += 2 * Math.PI / stepsPerRotation;
  		yield [Math.cos(theta), Math.sin(theta)];
  	}
  }

  // Animation is a little more involved.
  const [cx,cy] = [1,1];
  const stepsPerRotation = 120; //the more steps, the slower.

  const path = circlePath(stepsPerRotation);
  const state = {x: 0, y: 0, animating: true}

  // Combine two objects, mutating target
  const combine = (target, obj) => {
  	if (typeof obj === 'undefined') return;
  	for (const key in obj){
  		if (typeof target[key] === 'boolean'){
  			target[key] = !target[key];
  		} else {
  			target[key] = target[key] + obj[key];
  		}
  	}
  }

  // Render an object as svg attributes
  const render = (elt, obj) => {
  	for (const key in obj)
  		elt.setAttribute(key, obj[key]);
  }

  // The central loop, always running.
  const animate = ()=>{
  	if (state.animating){
	    let [dx, dy] = path.next().value;
	    [dx, dy] = [dx * cx, dy * cy];
	    combine (state, {x:dx, y:dy});
  	}
  	render (SQUARE, state);
  	requestAnimationFrame(animate);
  }

  // Give the user something to do with the keyboard.
	const inputs = {
		'd' : {x:10},
    'a' : {x:-10},
  	'w' : {y:-10},
    's' : {y:10},
    ' ' : {animating: 'toggle'},
	};

  document.body.addEventListener('keydown', e => {
  	const obj = inputs[e.key];
  	combine(state, obj);
  });

  animate();
  console.info(inputs);

  </script>
</body>

</html>
